version: '3'

services:

  ### DEV
  dev:
    image: &dev_version recruiter-1912/dev:0.0.1
    build:
      context: ./dev
      dockerfile: Dockerfile
    environment:
      SL_VERSION: *dev_version
    volumes:
      - ~/code:/app
      - ~/code/recruiter:/home/recruiter
      - ~/code/recruiter/platform:/home/recruiter/platform
      - ~/code/recruiter/scripts:/opt/scripts
    working_dir: /home/recruiter
    command: /bin/bash
    restart: always
    stdin_open: true
    tty: true

  ### API
  banana:
    image: &banana_version recruiter-1912/banana:0.0.1
    build:
      context: ./platform/banana
      dockerfile: Dockerfile
    depends_on:
      - postgres
      - redis
    ports:
      - "7999:7999"
    environment:
      PORT: 7999
      REDIS_HOST: redis
      REDIS_PORT: "4999"
      POSTGRES_URL: postgresql://hello_fast:hello_fast@postgres:5432/hello_fast_dev
      SL_ENVIRONMENT: test
      SL_VERSION: *banana_version
    volumes:
      - ~/code/recruiter/platform:/home/platform
    working_dir: /home/platform/banana
    command: /home/platform/banana/serve.sh

  ### DATABASE
  postgres:
    image: postgres:12.4
    volumes:
      - postgres_data:/var/lib/postgresql/data/
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=hello_fast_dev
      - POSTGRES_USER=hello_fast
      - POSTGRES_PASSWORD=hello_fast

  redis:
    image: redis:6.0.6
    command: ["--notify-keyspace-events", "Ex", "--port 4999"]
    ports:
      - "4999:4999"
    tty: true

volumes:
  postgres_data:
